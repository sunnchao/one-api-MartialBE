# Claude Code 管理员操作指南

## 功能概述

管理员现在可以通过后台管理界面为用户手动发放 Claude Code 订阅套餐，支持用户搜索、套餐发放和订阅管理功能。

## 访问路径

管理员登录后，在左侧菜单中找到 **设置** > **运营** > **Claude Code 管理**

## 主要功能

### 1. 订阅管理

- **查看所有订阅**：显示系统中所有 Claude Code 订阅的列表
- **订阅信息**：包括用户ID、套餐类型、状态、时间范围、使用情况等
- **取消订阅**：对于活跃状态的订阅，管理员可以手动取消
- **分页浏览**：支持分页查看大量订阅数据

### 2. 用户搜索与套餐发放

#### 搜索用户
- 支持按用户ID、用户名或邮箱搜索用户
- 实时搜索结果显示
- 显示用户基本信息（ID、用户名、邮箱、余额、注册时间）

#### 发放套餐
1. 在搜索结果中点击 **发放套餐** 按钮
2. 选择套餐类型：
   - 基础版：$9.99/月，1000次/月，1个客户端
   - 专业版：$29.99/月，5000次/月，3个客户端
   - 企业版：$99.99/月，20000次/月，10个客户端
3. 设置订阅时长（1-12个月）
4. 填写发放原因（可选）
5. 确认发放

#### 发放特点
- **免费发放**：管理员发放的套餐价格为0，不收取费用
- **不自动续费**：手动发放的订阅默认不开启自动续费
- **即时生效**：发放后立即生效，用户可正常使用
- **操作日志**：所有发放操作都会记录在系统日志中

## API 接口说明

### 管理员搜索用户
```
GET /api/claude-code-admin/users/search?keyword={keyword}&page={page}&page_size={page_size}
```

### 发放订阅
```
POST /api/claude-code-admin/grant-subscription
{
  "user_id": 123,
  "plan_type": "basic",
  "duration": 3,
  "reason": "客服补偿"
}
```

### 取消订阅
```
DELETE /api/claude-code-admin/subscriptions/{subscription_id}
```

### 查看所有订阅
```
GET /api/claude-code-admin/subscriptions?page={page}&page_size={page_size}
```

## 权限要求

所有管理功能都需要管理员权限，使用 `middleware.AdminAuth()` 进行权限验证。

## 使用场景

1. **客服补偿**：为遇到问题的用户提供免费套餐补偿
2. **推广活动**：为参与活动的用户发放免费体验套餐
3. **内部测试**：为内部员工或测试用户发放测试套餐
4. **商务合作**：为合作伙伴提供免费套餐
5. **紧急处理**：处理订阅异常、取消错误订阅等

## 注意事项

1. **重复订阅检查**：系统会检查用户是否已有活跃订阅，如有则不允许重复发放
2. **操作记录**：所有管理员操作都会记录在系统日志中，便于审计
3. **订阅状态**：发放的订阅立即变为 "active" 状态
4. **客户端验证**：发放的套餐仍需遵守客户端验证规则
5. **使用统计**：发放的套餐会正常统计使用量，到期后自动过期

## 故障排除

### 常见问题

1. **用户不存在**：确认用户ID或用户名拼写正确
2. **用户已有订阅**：需要先处理现有订阅再发放新套餐
3. **套餐类型错误**：确保选择的套餐类型有效（basic/pro/enterprise）
4. **权限不足**：确认当前账户具有管理员权限

### 日志查看

管理员操作会在系统日志中记录，格式如下：
```
管理员 {admin_id} 为用户 {user_id} 手动发放 {plan_type} 套餐，时长 {duration} 个月，原因: {reason}
管理员 {admin_id} 取消了用户 {user_id} 的 Claude Code 订阅 {subscription_id}
```
